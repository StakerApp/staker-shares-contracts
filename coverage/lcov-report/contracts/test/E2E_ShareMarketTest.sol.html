<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\test\E2E_ShareMarketTest.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">all files</a> / <a href="index.html">contracts/test/</a> E2E_ShareMarketTest.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>0/55</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>0/20</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>0/7</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">0% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>0/52</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.0;
&nbsp;
import "./HEXMock.sol";
import "../ShareMinter.sol";
import "../ShareMarket.sol";
&nbsp;
contract E2E_ShareMarketTest is ShareMarket {
    HEX private _hexState = new HEX();
&nbsp;
    uint256 private constant INITIAL_BALANCE = 1e19;
    uint72 private constant STAKE_HEARTS = 1e17;
    uint72 private constant STAKE_SHARES = 1e15;
    uint72 private constant REWARD_HEARTS = 1e17;
&nbsp;
<span class="fstat-no" title="function not covered" >    constructor() ShareMarket(IERC20(address(_hexState)), address(this)) {</span>
<span class="cstat-no" title="statement not covered" >        _hexState.mintHearts(address(this), INITIAL_BALANCE)</span>;
<span class="cstat-no" title="statement not covered" >        _hexState.mintHearts(address(0x10000), INITIAL_BALANCE)</span>;
<span class="cstat-no" title="statement not covered" >        _hexState.mintHearts(address(0x20000), INITIAL_BALANCE)</span>;
<span class="cstat-no" title="statement not covered" >        _hexState.mintHearts(address(0x00a329C0648769a73afAC7F9381e08fb43DBEA70), INITIAL_BALANCE)</span>;
    }
&nbsp;
    uint40 private _latestStakeId;
&nbsp;
    struct Listing {
        uint40 stakeId;
        address supplier;
        uint72 stakedHearts;
        uint72 stakeShares;
        uint72 heartsEarned;
        bool earningsMinted;
    }
    Listing[] public _listings;
&nbsp;
    mapping(address =&gt; uint256) private _heartsInterestEarned;
    mapping(address =&gt; uint256) private _heartsMinted;
&nbsp;
<span class="fstat-no" title="function not covered" >    function mint_shares(</span>
        uint72 stakeHearts,
        uint72 stakeShares,
        uint72 rewardHearts
    ) public {
<span class="cstat-no" title="statement not covered" >        require(stakeHearts != 0 &amp;&amp; stakeShares != 0 &amp;&amp; rewardHearts &gt;= stakeHearts, "Invalid params")</span>;
<span class="cstat-no" title="statement not covered" >        Listing memory listing = Listing(_latestStakeId++, msg.sender, stakeHearts, stakeShares, rewardHearts, false);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        _hexState.burnHearts(msg.sender, listing.stakedHearts)</span>;
<span class="cstat-no" title="statement not covered" >        _heartsMinted[msg.sender] += listing.stakedHearts</span>;
<span class="cstat-no" title="statement not covered" >        this.onSharesMinted(listing.stakeId, listing.supplier, listing.stakedHearts, listing.stakeShares)</span>;
&nbsp;
<span class="cstat-no" title="statement not covered" >        _listings.push(listing)</span>;
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function mint_earnings() public {</span>
<span class="cstat-no" title="statement not covered" >        require(_listings.length != 0, "Requires listings")</span>;
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; _listings.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            Listing storage listing = _listings[i];</span>
<span class="cstat-no" title="statement not covered" >            if (listing.earningsMinted) continue;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            listing.earningsMinted = true</span>;
<span class="cstat-no" title="statement not covered" >            _hexState.mintHearts(address(this), listing.heartsEarned)</span>;
<span class="cstat-no" title="statement not covered" >            _heartsInterestEarned[listing.supplier] += listing.heartsEarned - listing.stakedHearts</span>;
<span class="cstat-no" title="statement not covered" >            this.onEarningsMinted(listing.stakeId, listing.heartsEarned)</span>;
        }
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function echidna_buy_shares() public returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; _listings.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            Listing memory listing = _listings[i];</span>
<span class="cstat-no" title="statement not covered" >            (uint256 heartsBalance, uint256 sharesBalance) = this.listingBalances(listing.stakeId);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            if (sharesBalance != 0 &amp;&amp; heartsBalance != 0 &amp;&amp; hexContract.balanceOf(msg.sender) &gt;= heartsBalance) {</span>
<span class="cstat-no" title="statement not covered" >                uint256 balBef = hexContract.balanceOf(msg.sender);</span>
<span class="cstat-no" title="statement not covered" >                uint256 sharesBef = this.sharesOwned(listing.stakeId, msg.sender);</span>
<span class="cstat-no" title="statement not covered" >                address(this).delegatecall(</span>
                    abi.encodeWithSignature(
                        "buyShares(uint40,address,uint256)",
                        listing.stakeId,
                        msg.sender,
                        sharesBalance
                    )
                );
<span class="cstat-no" title="statement not covered" >                uint256 balAft = hexContract.balanceOf(msg.sender);</span>
<span class="cstat-no" title="statement not covered" >                uint256 sharesAft = this.sharesOwned(listing.stakeId, msg.sender);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                uint256 heartsCost = balBef - balAft;</span>
<span class="cstat-no" title="statement not covered" >                if (heartsCost != heartsBalance) <span class="cstat-no" title="statement not covered" >return false;</span></span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                uint256 sharesGained = sharesAft - sharesBef;</span>
<span class="cstat-no" title="statement not covered" >                if (sharesGained != sharesBalance) <span class="cstat-no" title="statement not covered" >return false;</span></span>
            }
        }
<span class="cstat-no" title="statement not covered" >        return true;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function echidna_claim_earnings() public returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; _listings.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            Listing memory listing = _listings[i];</span>
<span class="cstat-no" title="statement not covered" >            if (!listing.earningsMinted) continue;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            uint256 sharesOwned = this.sharesOwned(listing.stakeId, msg.sender);</span>
<span class="cstat-no" title="statement not covered" >            (uint256 heartsEarned, uint256 sharesTotal) = this.listingEarnings(listing.stakeId);</span>
<span class="cstat-no" title="statement not covered" >            uint256 expectedHeartsEarned = FullMath.mulDiv(heartsEarned, sharesOwned, sharesTotal);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            if (sharesOwned != 0 &amp;&amp; heartsEarned != 0 &amp;&amp; expectedHeartsEarned != 0) {</span>
<span class="cstat-no" title="statement not covered" >                uint256 balBef = hexContract.balanceOf(msg.sender);</span>
<span class="cstat-no" title="statement not covered" >                address(this).delegatecall(abi.encodeWithSignature("claimEarnings(uint40)", listing.stakeId))</span>;
<span class="cstat-no" title="statement not covered" >                uint256 balAft = hexContract.balanceOf(msg.sender);</span>
<span class="cstat-no" title="statement not covered" >                uint256 earnings = balAft - balBef;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >                if (expectedHeartsEarned != earnings) <span class="cstat-no" title="statement not covered" >return false;</span></span>
            }
        }
<span class="cstat-no" title="statement not covered" >        return true;</span>
    }
&nbsp;
<span class="fstat-no" title="function not covered" >    function echidna_balance_never_exceeds_initial_plus_interest() public view returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        return</span>
            hexContract.balanceOf(address(0x10000)) &lt;= INITIAL_BALANCE + _heartsInterestEarned[address(0x10000)] &amp;&amp;
            hexContract.balanceOf(address(0x20000)) &lt;= INITIAL_BALANCE + _heartsInterestEarned[address(0x20000)] &amp;&amp;
            hexContract.balanceOf(address(0x00a329C0648769a73afAC7F9381e08fb43DBEA70)) &lt;=
            INITIAL_BALANCE + _heartsInterestEarned[address(0x00a329C0648769a73afAC7F9381e08fb43DBEA70)];
    }
&nbsp;
    //hearts in listing cannot exceed hearts staked
<span class="fstat-no" title="function not covered" >    function echidna_listing_values_cannot_exceed_initial() public view returns (bool) {</span>
<span class="cstat-no" title="statement not covered" >        for (uint256 i = 0; i &lt; _listings.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >            Listing memory listing = _listings[i];</span>
<span class="cstat-no" title="statement not covered" >            ShareListing memory shareListing = shareListings[listing.stakeId];</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >            if (shareListing.heartsBalance &gt; listing.stakedHearts || shareListing.sharesBalance &gt; listing.stakeShares)</span>
<span class="cstat-no" title="statement not covered" >                return false;</span>
        }
<span class="cstat-no" title="statement not covered" >        return true;</span>
    }
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Jun 15 2021 01:07:52 GMT-0400 (Eastern Daylight Time)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
